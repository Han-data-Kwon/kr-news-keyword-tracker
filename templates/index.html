<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>국내 뉴스 & 기업 정보 키워드 검색기</title>

  <!-- ✅ Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    h2 {
      margin-bottom: 2rem;
    }
    .section {
      margin-top: 1rem;
    }
    table {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h2>국내 뉴스 & 기업 정보 키워드 검색기</h2>

  <!-- ✅ 탭 버튼 영역 -->
  <ul class="nav nav-tabs my-4" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="news-tab" data-bs-toggle="tab" data-bs-target="#news-section" type="button" role="tab" aria-controls="news-section" aria-selected="true">
        뉴스 검색
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="company-tab" data-bs-toggle="tab" data-bs-target="#company-section" type="button" role="tab" aria-controls="company-section" aria-selected="false">
        기업 정보 검색
      </button>
    </li>
  </ul>

  <!-- ✅ 탭 콘텐츠 영역 -->
  <div class="tab-content">
    <!-- 📌 뉴스 검색 탭 -->
    <div class="tab-pane fade show active" id="news-section" role="tabpanel" aria-labelledby="news-tab">
      <div class="mb-3">
        <input type="text" id="keyword" class="form-control" placeholder="예: 복지, B2B, 트럼프" />
        <button class="btn btn-success mt-2" onclick="searchNews()">검색</button>
      </div>
      <div id="news-container" class="mb-4"></div>
      <div id="trend-charts"></div>
    </div>

    <!-- 📌 사업자등록 상태조회 탭 -->
    <div class="tab-pane fade" id="company-section" role="tabpanel" aria-labelledby="company-tab">
      <h5>📁 사업자등록번호 엑셀 업로드</h5>
      <form id="ntsForm" enctype="multipart/form-data">
        <div class="input-group mb-3">
          <input type="file" name="file" accept=".xlsx" class="form-control" required>
          <button type="submit" class="btn btn-primary">조회</button>
        </div>
        <div class="form-text">※ 엑셀에 <strong>'사업자등록번호'</strong> 컬럼이 포함되어 있어야 합니다.</div>
      </form>
      <table class="table table-bordered mt-3" id="nts-result-table">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>사업자등록번호</th>
            <th>상태</th>
            <th>과세유형</th>
            <th>폐업일자</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ✅ Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ✅ JS 기능 정의 -->
  <script>
    function searchNews() {
      const keyword = document.getElementById("keyword").value.trim();
      if (!keyword) return alert("검색어를 입력해주세요.");

      fetch(`/api/search_news?q=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("news-container");
          container.innerHTML = "";
          if (data.length === 0) {
            container.innerHTML = "<p>검색 결과가 없습니다.</p>";
            return;
          }
          data.forEach((item, idx) => {
            const div = document.createElement("div");
            div.innerHTML = `
              <p><strong>${idx + 1}. <a href="${item.link}" target="_blank">${item.title}</a></strong></p>
              <small>${new Date(item.date).toLocaleString("ko-KR")}</small><hr>
            `;
            container.appendChild(div);
          });
        });
    }

    
  // ✅ 수정된 JavaScript 코드 전체
  document.getElementById("ntsForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("/api/nts", {
      method: "POST",
      body: formData
    })
    .then(async (res) => {
      if (!res.ok) {
        const errData = await res.json().catch(() => ({ error: "서버 오류 발생" }));
        alert("❌ " + (errData.error || "요청 실패"));
        throw new Error("HTTP error " + res.status);
      }
      return res.json();
    })
    .then(data => {
      const tbody = document.querySelector("#nts-result-table tbody");
      tbody.innerHTML = "";

      if (data.error) {
        alert(data.error);
        return;
      }

      data.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${row["사업자등록번호"]}</td>
          <td>${row["상태"]}</td>
          <td>${row["과세유형"]}</td>
          <td>${row["폐업일자"] || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error("🚨 요청 실패:", err);
    });
  });
</script>
</body>
</html>
