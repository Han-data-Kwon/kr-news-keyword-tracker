<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>êµ­ë‚´ ë‰´ìŠ¤ & ê¸°ì—… ì •ë³´ í‚¤ì›Œë“œ ê²€ìƒ‰ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    input, button { padding: 8px; font-size: 14px; }
    canvas { width: 100% !important; height: 200px !important; max-height: 220px; }
    .tabs { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
    .tab-button { padding: 8px 16px; background: #ddd; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
    .tab-button.active { background: #4285f4; color: white; }
    .section { display: none; }
    .section.active { display: block; }
    .tab-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .tab { padding: 6px 12px; background: #e0e0e0; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .tab span { font-weight: bold; }
    .tab .close { background: transparent; border: none; color: red; font-weight: bold; cursor: pointer; }
    .tab:hover { background: #d4d4d4; }
    .news-table { margin-top: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #fff; }
    .trend-container { margin-top: 10px; background: #fff; padding: 15px; border-radius: 6px; }
    .trend-header { display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; text-align: left; }
    tr.highlight { background-color: #fff7cc; }
    button.remove-btn, .delete-btn {
      background: red; color: white; border: none;
      padding: 4px 8px; cursor: pointer; border-radius: 4px;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      td { border: none; padding: 4px 0; }
    }
  </style>
</head>
<body>

<h2>êµ­ë‚´ ë‰´ìŠ¤ & ê¸°ì—… ì •ë³´ í‚¤ì›Œë“œ ê²€ìƒ‰ê¸°</h2>

<div class="tabs">
  <button class="tab-button active" onclick="switchTab('news-section', this)">ë‰´ìŠ¤ ê²€ìƒ‰</button>
  <button class="tab-button" onclick="switchTab('company-section', this)">ê¸°ì—… ì •ë³´ ê²€ìƒ‰</button>
</div>

<!-- ë‰´ìŠ¤ ê²€ìƒ‰ íƒ­ -->
<div id="news-section" class="section active">
  <div class="tab-bar" id="favorite-tabs"></div>
  <input type="text" id="keyword" placeholder="ì˜ˆ: ë³µì§€, B2B, íŠ¸ëŸ¼í”„" />
  <button onclick="searchNews()">ê²€ìƒ‰</button>
  <div id="news-container"></div>
  <div id="trend-charts"></div>
</div>

<!-- ì‚¬ì—…ìë“±ë¡ ìƒíƒœì¡°íšŒ íƒ­ -->
<div id="company-section" class="section">
  <div class="my-4">
    <h5>ğŸ“ ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ì—‘ì…€ ì—…ë¡œë“œ</h5>
    <form id="ntsForm" enctype="multipart/form-data">
      <div class="input-group mb-3">
        <input type="file" name="file" accept=".xlsx" class="form-control" required>
        <button type="submit" class="btn btn-primary">ì¡°íšŒ</button>
      </div>
      <div class="form-text">â€» ì—‘ì…€ì— <strong>'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸'</strong> ì»¬ëŸ¼ì´ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</div>
    </form>
  </div>

  <div id="ntsResult" class="table-responsive d-none">
    <h6 class="mt-4">âœ… ì¡°íšŒ ê²°ê³¼</h6>
    <table class="table table-bordered table-striped text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th>
          <th>ìƒíƒœ</th>
          <th>ê³¼ì„¸ìœ í˜•</th>
          <th>íì—…ì¼ì</th>
        </tr>
      </thead>
      <tbody id="ntsTableBody"></tbody>
    </table>
  </div>
</div>

<script>
const positiveWords = ["ê¸‰ë“±", "í˜¸ì¬", "ì„±ì¥", "ê¸°ëŒ€", "íšŒë³µ", "ë°˜ë“±", "ëŒíŒŒ", "ìƒìŠ¹", "ê°•ì„¸", "ê°œì„ ", "í™•ëŒ€", "ìœ ë§", "ì•ˆì •", "ê¸°ë¡", "ì‹ ê¸°ë¡", "ìµœê³ ", "ì¸í•˜", "ì™„í™”", "ë„ì…", "ìŠ¹ì¸"];
const negativeWords = ["í•˜ë½", "í­ë½", "ê¸‰ë½", "ì¶”ë½", "ë¶•ê´´", "ìš°ë ¤", "ë¶ˆì•ˆ", "ì¹¨ì²´", "ìœ„ê¸°", "ì ì", "ì•…ì¬", "ë‘”í™”", "íŒ¨ë°°", "ì‹¤íŒ¨", "ê°ì†Œ", "í•˜íšŒ", "ê²½ê³ ", "ì—°ê¸°", "ìœ„í˜‘", "íƒ€ê²©"];

function analyzeSentiment(text) {
  const lower = text.toLowerCase();
  const pos = positiveWords.some(w => lower.includes(w));
  const neg = negativeWords.some(w => lower.includes(w));
  if (pos && !neg) return "pos";
  if (neg && !pos) return "neg";
  return "neu";
}

function sentimentLabel(type) {
  if (type === "pos") return "ê¸ì •";
  if (type === "neg") return "ë¶€ì •";
  return "ì¤‘ë¦½";
}

function switchTab(id, button) {
  document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  button.classList.add('active');
  localStorage.setItem("currentTab", id);
}

window.addEventListener("DOMContentLoaded", () => {
  // íƒ­ ë³µì›
  const savedTab = localStorage.getItem("currentTab") || "news-section";
  const savedButton = document.querySelector(`.tab-button[onclick*="${savedTab}"]`);
  if (savedButton) switchTab(savedTab, savedButton);

  // ì‚¬ì—…ìë“±ë¡ ì¡°íšŒ submit
  const form = document.getElementById("ntsForm");
  form.addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(form);

    fetch("/api/nts", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      const resultBox = document.getElementById("ntsResult");
      const tableBody = document.getElementById("ntsTableBody");
      tableBody.innerHTML = "";

      if (data.error) {
        alert(data.error);
        resultBox.classList.add("d-none");
        return;
      }

      data.forEach((item, index) => {
        const row = `<tr>
          <td>${index + 1}</td>
          <td>${item["ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸"]}</td>
          <td>${item["ìƒíƒœ"]}</td>
          <td>${item["ê³¼ì„¸ìœ í˜•"]}</td>
          <td>${item["íì—…ì¼ì"] || "-"}</td>
        </tr>`;
        tableBody.insertAdjacentHTML("beforeend", row);
      });

      resultBox.classList.remove("d-none");
    })
    .catch(err => {
      console.error("ì¡°íšŒ ì˜¤ë¥˜:", err);
      alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
  });

  // í‚¤ì›Œë“œ ìë™ ë³µì› ë° ë‰´ìŠ¤ ì¡°íšŒ
  const keywords = getSortedTopKeywords();
  keywords.forEach(k => {
    searchNews(k, false);
    renderTrendChart(k);
  });
  renderTabs();

  setInterval(() => {
    const keywords = getSortedTopKeywords();
    keywords.forEach(k => refreshNews(k));
  }, 10 * 60 * 1000);
});

let tableCount = 0;
const maxTables = 15;
const savedKeywordsKey = "savedKeywords";
const keywordFreqKey = "keywordFreq";
const lastHashes = {};
const lastLinks = {};

function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function searchNews(keyword = "", save = true) {
  if (!keyword) keyword = document.getElementById("keyword").value.trim();
  if (!keyword) return alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  if (tableCount >= maxTables) return alert("ìµœëŒ€ 15ê°œì˜ ê²€ìƒ‰ ê²°ê³¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤.");

  fetch(`/api/search_news?q=${encodeURIComponent(keyword)}`)
    .then(res => res.ok ? res.json() : Promise.reject(res))
    .then(data => {
      if (!data.length) return alert("ë‰´ìŠ¤ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
      const hash = data.map(d => d.link).join(",");
      const prevLinks = lastLinks[keyword] || [];
      const newLinks = data.map(d => d.link);
      const isNew = hash !== lastHashes[keyword];
      if (isNew && document.getElementById('news-section').classList.contains('active')) {
        alert(`"${keyword}"ì˜ ìƒˆ ë‰´ìŠ¤ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      lastHashes[keyword] = hash;
      lastLinks[keyword] = newLinks;

      const old = document.getElementById("table-" + keyword);
      if (old) old.remove();

      tableCount++;
      const div = document.createElement("div");
      div.className = "news-table";
      div.id = "table-" + keyword;

      let html = `
        <h3>
          ${keyword} ê´€ë ¨ ë‰´ìŠ¤
          <button class="remove-btn" onclick="removeTableOnly('${div.id}')">ì‚­ì œ</button>
        </h3>
        <table>
          <thead><tr><th>ì œëª©</th><th>ì¶œì²˜</th><th>ë‚ ì§œ</th><th>ê°ì„±</th></tr></thead>
          <tbody>`;

      data.forEach(item => {
        const raw = item.description || item.title || "";
        const clean = raw.replace(/<[^>]+>/g, "");
        const sentiment = analyzeSentiment(item.title + " " + clean);
        const sentimentIcon = sentiment === "pos" ? "â–²" : sentiment === "neg" ? "â–¼" : "â—";
        const sentimentColor = sentiment === "pos" ? "green" : sentiment === "neg" ? "red" : "gray";
        const highlightClass = !prevLinks.includes(item.link) ? "highlight" : "";

        html += `
          <tr class="${highlightClass}">
            <td><a href="${item.link}" target="_blank">${item.title}</a></td>
            <td>${item.source}</td>
            <td>${item.date}</td>
            <td style="color:${sentimentColor}; font-weight:bold;">${sentimentIcon} ${sentimentLabel(sentiment)}</td>
          </tr>`;
      });

      html += "</tbody></table>";
      div.innerHTML = html;
      document.getElementById("news-container").prepend(div);

      if (save) {
        const keywords = JSON.parse(localStorage.getItem(savedKeywordsKey) || "[]");
        const freqs = JSON.parse(localStorage.getItem(keywordFreqKey) || "{}");
        freqs[keyword] = (freqs[keyword] || 0) + 1;
        localStorage.setItem(keywordFreqKey, JSON.stringify(freqs));
        if (!keywords.includes(keyword)) {
          keywords.push(keyword);
          localStorage.setItem(savedKeywordsKey, JSON.stringify(keywords));
        }
        renderTabs();
        renderTrendChart(keyword);
      }
    })
    .catch(err => {
      if (err.status === 403 || err.status === 429) alert("ê²€ìƒ‰ëŸ‰ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.");
      else alert("ë‰´ìŠ¤ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });
}

function refreshNews(keyword) {
  fetch(`/api/search_news?q=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) return;
      const hash = data.map(d => d.link).join(",");
      const prevLinks = lastLinks[keyword] || [];
      const isNew = hash !== lastHashes[keyword];
      if (isNew && document.getElementById('news-section').classList.contains('active')) {
        alert(`"${keyword}"ì˜ ìƒˆ ë‰´ìŠ¤ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      lastHashes[keyword] = hash;
      lastLinks[keyword] = data.map(d => d.link);
      const div = document.getElementById("table-" + keyword);
      if (div) div.remove();
      tableCount--;
      searchNews(keyword, false);
    });
}

function removeTableOnly(id) {
  const el = document.getElementById(id);
  if (el) {
    el.remove();
    tableCount--;
  }
}

function removeKeywordCompletely(keyword) {
  removeTableOnly("table-" + keyword);
  document.getElementById("trend-" + keyword)?.remove();
  const keywords = JSON.parse(localStorage.getItem(savedKeywordsKey) || "[]").filter(k => k !== keyword);
  localStorage.setItem(savedKeywordsKey, JSON.stringify(keywords));
  const freqs = JSON.parse(localStorage.getItem(keywordFreqKey) || "{}");
  delete freqs[keyword];
  localStorage.setItem(keywordFreqKey, JSON.stringify(freqs));
  renderTabs();
}

function renderTabs() {
  const keywords = getSortedTopKeywords();
  const container = document.getElementById("favorite-tabs");
  container.innerHTML = "";
  keywords.forEach(k => {
    const tab = document.createElement("div");
    tab.className = "tab";
    const span = document.createElement("span");
    span.innerText = k;
    span.onclick = () => {
      searchNews(k, false);
      renderTrendChart(k);
    };
    const closeBtn = document.createElement("button");
    closeBtn.className = "close";
    closeBtn.innerText = "x";
    closeBtn.onclick = (e) => {
      e.stopPropagation();
      removeKeywordCompletely(k);
    };
    tab.appendChild(span);
    tab.appendChild(closeBtn);
    container.appendChild(tab);
  });
}

function getSortedTopKeywords() {
  const keywords = JSON.parse(localStorage.getItem(savedKeywordsKey) || "[]");
  const freqs = JSON.parse(localStorage.getItem(keywordFreqKey) || "{}");
  return keywords.sort((a, b) => (freqs[b] || 0) - (freqs[a] || 0)).slice(0, 5);
}

function renderTrendChart(keyword, period = "30d") {
  fetch(`/api/trend?q=${encodeURIComponent(keyword)}&period=${period}`)
    .then(res => res.json())
    .then(data => {
      let maxY = Math.max(...data.map(d => d.ratio), 100);
      let container = document.getElementById("trend-" + keyword);
      let canvas;

      if (container) {
        container.querySelector("h4").innerText = `${keyword} ê²€ìƒ‰ íŠ¸ë Œë“œ (${period === "1y" ? "1ë…„" : "30ì¼"})`;
        canvas = container.querySelector("canvas");
        const newCanvas = canvas.cloneNode(true);
        canvas.parentNode.replaceChild(newCanvas, canvas);
        canvas = newCanvas;
      } else {
        container = document.createElement("div");
        container.className = "trend-container";
        container.id = "trend-" + keyword;

        const header = document.createElement("div");
        header.className = "trend-header";
        header.innerHTML = `<h4>${keyword} ê²€ìƒ‰ íŠ¸ë Œë“œ (${period === "1y" ? "1ë…„" : "30ì¼"})</h4>
          <div>
            <button onclick="renderTrendChart('${keyword}', '30d')">30ì¼</button>
            <button onclick="renderTrendChart('${keyword}', '1y')">1ë…„</button>
          </div>`;

        canvas = document.createElement("canvas");
        canvas.id = "chart-" + keyword;

        container.appendChild(header);
        container.appendChild(canvas);
        document.getElementById("trend-charts").appendChild(container);
      }

      const ctx = canvas.getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(d => d.date),
          datasets: [{
            label: keyword + " ê²€ìƒ‰ ë¹„ìœ¨",
            data: data.map(d => d.ratio),
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.1)",
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          scales: {
            x: { ticks: { maxTicksLimit: 6 } },
            y: { beginAtZero: true, suggestedMax: maxY }
          },
          plugins: { legend: { display: false } },
          interaction: { mode: 'index', intersect: false },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    });
}

</script>

</body>
</html>
